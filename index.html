<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üç† UbeStudy - Full App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root { --ube:#957DAD; --dark:#4A148C; --bg:#F8F9FE; }
* { box-sizing:border-box; font-family:'Nunito', sans-serif; }
body { background:var(--bg); margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; }

/* Views */
.view { display:none; width:100%; max-width:480px; padding:15px; text-align:center; }
.view.active { display:flex; flex-direction:column; align-items:center; }

/* Cards and buttons */
.card { background:white; padding:20px; border-radius:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); width:100%; margin:10px 0; }
input { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:2px solid #eee; font-size:15px; outline:none; }
button { width:100%; padding:14px; border:none; border-radius:12px; font-weight:800; cursor:pointer; margin-top:10px; background:var(--ube); color:white; transition:0.3s; }
button:hover { background:var(--dark); }

/* Subject cards */
.subject-card { background:#F9F9F9; margin:8px 0; padding:12px; border-radius:12px; cursor:pointer; position:relative; text-align:left; font-size:16px; }
.subject-card:hover .desc { display:block; }
.desc { display:none; position:absolute; top:0; left:105%; width:200px; background:white; border:1px solid #ccc; padding:8px; border-radius:10px; font-size:13px; box-shadow:0 4px 10px rgba(0,0,0,0.1); z-index:10; }

/* Level & status */
.level { margin:10px 0; font-size:14px; text-align:left; }
#status { margin-top:10px; font-weight:bold; font-size:14px; color:red; }
.switch { margin-top:10px; font-size:14px; cursor:pointer; color:var(--dark); font-weight:700; }
.ranking-card { text-align:left; padding:10px; margin:6px 0; background:#F0F0F0; border-radius:10px; }
.ranking-name { font-weight:700; }

/* Mobile responsive */
@media(max-width:480px){
    .desc { left:50%; transform:translateX(10px); width:180px; font-size:12px; }
}
</style>
</head>
<body>

<!-- Auth View -->
<div id="view-auth" class="view active">
    <div class="card">
        <h1 style="color:var(--dark)">üç† UbeStudy</h1>
        <h3 id="formTitle">Sign Up</h3>
        <input type="text" id="name" placeholder="Full Name">
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="authBtn">Create Account</button>
        <div class="switch" id="toggleMode">Already have an account? Login</div>
        <div id="status"></div>
    </div>
</div>

<!-- Home / Subject Selection -->
<div id="view-home" class="view">
    <h1 style="color:var(--dark)">Welcome, <span id="user-name">Student</span>!</h1>
    <h3>Select a Subject:</h3>
    <div id="subjects-container"></div>
    <div class="level" id="user-level"></div>
    <button onclick="app.showRanking()" style="background:#ddd;color:#333;">View Rankings</button>
    <button style="background:#ddd;color:#666;" onclick="app.logout()">Logout</button>
</div>

<!-- Subject Review Mode -->
<div id="view-subject" class="view">
    <h2 id="subject-title" style="color:var(--dark)"></h2>
    <p>Choose number of items:</p>
    <div id="item-options"></div>
    <button onclick="app.showView('view-home')" style="background:#ddd;color:#666;margin-top:20px;">Back to Subjects</button>
</div>

<!-- Ranking View -->
<div id="view-ranking" class="view">
    <h2 style="color:var(--dark)">Leaderboard</h2>
    <div id="ranking-list"></div>
    <button onclick="app.showView('view-home')" style="background:#ddd;color:#666;margin-top:20px;">Back</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// --- CONFIG ---
const SUPABASE_URL = "https://tbftpvkydneckzdpfdev.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRiZnRwdmt5ZG5lY2t6ZHBmZGV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNDQxMDIsImV4cCI6MjA4NjYyMDEwMn0.21_APgXQVIeVSuHsNMqa55UGNFOEdDUYvNaUI1_XkY4";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// --- DATA ---
const SUBJECTS = [
    { name:"Crop Science", desc:"Principles of agronomy, field crops, horticulture, physiology, and plant breeding."},
    { name:"Soil Science", desc:"Focuses on soil management, fertility, and conservation."},
    { name:"Crop Protection", desc:"Plant pests, diseases, and management."},
    { name:"Animal Science", desc:"Livestock production and management."},
    { name:"Agri Economics & Marketing", desc:"Agribusiness and marketing principles."},
    { name:"Agri Extension & Communication", desc:"Communication strategies for agricultural development."}
];

const LEVELS = [
    { max:5, icon:"üå± Seedling (Beginner)"},
    { max:10, icon:"üë®‚Äçüåæ Backyard Gardener (Amateur)"},
    { max:20, icon:"üöú Field Manager (Intermediate)"},
    { max:40, icon:"üåæ Agronomist (Advanced)"},
    { max:50, icon:"üëë Secretary of Agriculture (Top Rank)"}
];

// --- APP ---
window.app = {
    user:null,
    levelPoints:0,
    isLogin:false,

    showView(id){
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    },

    async handleAuth(){
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const name = document.getElementById("name").value;
        const status = document.getElementById("status");
        status.style.color="blue"; status.innerText="Processing...";

        try{
            let res;
            if(this.isLogin){
                res = await supabase.auth.signInWithPassword({email,password});
            } else {
                res = await supabase.auth.signUp({email,password,options:{data:{full_name:name}}});
            }
            if(res.error) throw res.error;

            if(this.isLogin) this.loadHome();
            else {status.style.color="green"; status.innerText="Signup successful! Please login.";}
        } catch(err){
            status.style.color="red"; status.innerText=err.message;
        }
    },

    async loadHome(){
        const { data:{ user } } = await supabase.auth.getUser();
        if(user){
            this.user=user;
            document.getElementById("user-name").innerText = user.user_metadata.full_name || "Student";
            this.showSubjects();
            this.showView("view-home");
        }
    },

    logout: async function(){
        await supabase.auth.signOut();
        location.reload();
    },

    showSubjects(){
        const container = document.getElementById("subjects-container");
        container.innerHTML="";
        SUBJECTS.forEach(sub=>{
            const div = document.createElement("div");
            div.className="subject-card";
            div.innerText=sub.name;
            const desc = document.createElement("div");
            desc.className="desc";
            desc.innerText=sub.desc;
            div.appendChild(desc);
            div.onclick = () => this.selectSubject(sub);
            container.appendChild(div);
        });
        this.showLevel();
    },

    showLevel(){
        let lvl = LEVELS.find(l=>this.levelPoints<=l.max) || LEVELS[LEVELS.length-1];
        document.getElementById("user-level").innerText = `Level: ${lvl.icon} | Points: ${this.levelPoints}`;
    },

    selectSubject(sub){
        document.getElementById("subject-title").innerText=sub.name;
        const container = document.getElementById("item-options");
        container.innerHTML="";
        [15,30,50,70,100].forEach(n=>{
            const btn = document.createElement("button");
            btn.innerText=`${n} items`;
            btn.onclick = () => alert(`You selected ${n} items for ${sub.name} review!`);
            container.appendChild(btn);
        });
        this.showView("view-subject");
    },

    async showRanking(){
        const { data, error } = await supabase
            .from("user_scores")
            .select("user_name,subject,points")
            .order("points",{ascending:false})
            .limit(20);
        const container = document.getElementById("ranking-list");
        container.innerHTML="";
        if(error) container.innerText="Error loading rankings";
        else{
            data.forEach((r,i)=>{
                const div = document.createElement("div");
                div.className="ranking-card";
                div.innerHTML=`${i+1}. <span class="ranking-name">${r.user_name}</span> - ${r.subject}: ${r.points} pts`;
                container.appendChild(div);
            });
        }
        this.showView("view-ranking");
    }
};

// --- BUTTON LISTENERS ---
document.getElementById("authBtn").onclick=()=>app.handleAuth();
document.getElementById("toggleMode").onclick=()=>{
    app.isLogin = !app.isLogin;
    document.getElementById("formTitle").innerText = app.isLogin ? "Login" : "Sign Up";
    document.getElementById("authBtn").innerText = app.isLogin ? "Login" : "Create Account";
    document.getElementById("name").classList.toggle("hidden", app.isLogin);
    document.getElementById("toggleMode").innerText = app.isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
};

// --- INIT ---
app.loadHome();
</script>
</body>
</html>
